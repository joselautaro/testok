<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Clientes | Testok</title>

  <!-- Tipografías -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@500;600;700&family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --primary: #084391;
      --secondary: #0dffdc;

      --ink: #0b0f19;
      --muted: #4b5b73;

      --bg-1: #f4f8ff;

      --card: #ffffff;
      --shadow: 0 14px 40px rgba(8, 67, 145, .18);
      --shadow-soft: 0 8px 24px rgba(8, 67, 145, .12);
      --radius: 18px;

      --danger: #b00020;
      --danger-bg: #ffecec;

      --ok-bg: rgba(13, 255, 220, .18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(900px 420px at 80% 10%, rgba(13, 255, 220, .16), transparent 60%),
        linear-gradient(180deg, var(--bg-1) 0%, #ffffff 42%);
      color: var(--ink);
      font-family: Roboto, system-ui, -apple-system, Segoe UI, sans-serif;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ================= HEADER ================= */
    .hero {
      background: linear-gradient(90deg, #06336d, var(--primary));
      color: #fff;
      padding: 16px 18px 0;
    }

    .hero-top {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding-bottom: 14px;
    }

    .logo-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 14px;
    }

    .logo-img {
      height: 34px;
      width: auto;
      max-width: 220px;
      display: block;
      object-fit: contain;
    }

    /* ================= NAVBAR ================= */
    .nav {
      border-top: 1px solid rgba(255, 255, 255, .14);
      background: rgba(0, 0, 0, .06);
    }

    .nav-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px 18px 14px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 18px;
    }

    .nav-left {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 320px;
    }

    .kicker {
      font-family: "Josefin Sans", sans-serif;
      font-size: 18px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 8px 12px;
      background: var(--secondary);
      color: #002a3a;
      border-radius: 10px;
      display: inline-block;
      width: fit-content;
    }

    .subtitle {
      margin: 0;
      font-size: 13px;
      line-height: 1.45;
      color: #e6f1ff;
      max-width: 56ch;
    }

    .brand-tag {
      font-size: 12px;
      color: rgba(230, 241, 255, .92);
      line-height: 1.2;
      max-width: 260px;
    }

    .nav-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      padding: 11px 16px;
      border-radius: 12px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: filter .15s ease, transform .06s ease, background .15s ease;
      font-family: Roboto, sans-serif;
      user-select: none;
      white-space: nowrap;
    }

    .btn-light {
      background: #fff;
      color: var(--primary);
      border-color: rgba(255, 255, 255, .6);
      box-shadow: 0 10px 22px rgba(6, 26, 51, .12);
    }

    .btn-light:hover {
      filter: brightness(.98);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.5);
      color: #000000;
      border-color: rgba(10, 9, 9, 0.22);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, .14);
    }

    .btn:active {
      transform: translateY(1px);
    }

    @media (max-width: 900px) {
      .nav-inner {
        flex-direction: column;
        align-items: flex-start;
      }

      .nav-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .nav-left {
        min-width: 0;
      }
    }

    @media (max-width: 520px) {
      .logo-img {
        height: 30px;
        max-width: 190px;
      }

      .logo-pill {
        padding: 9px 12px;
        border-radius: 14px;
      }
    }

    /* ================= CONTENT ================= */
    .container {
      width: 100%;
      max-width: 1100px;
      margin: 40px auto 40px;
      padding: 0 18px;
    }

    /* ====== LAYOUT: con panel a la derecha (detalle) ====== */
    .layout {
      display: grid;
      grid-template-columns: 1fr 270px;
      gap: 15px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 2fr;
      }
    }

    /* ====== GRID: por defecto 3 columnas (cuando NO hay panel visible) ====== */
    .grid {
      display: grid;
      gap: 13px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      align-items: center;
    }

    /* Cuando el panel está visible, forzamos 3 columnas */
    .layout.has-panel .grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    /* Responsivo: baja columnas en pantallas más chicas */
    @media (max-width: 1100px) {
      .grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .layout.has-panel .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 820px) {
      .grid,
      .layout.has-panel .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 480px) {
      .grid,
      .layout.has-panel .grid {
        grid-template-columns: 1fr;
      }
    }

    .card-link {
      text-decoration: none;
      color: inherit;
      display: block;
      height: 100%;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(8, 67, 145, .10);
      padding: 14px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      height: 100%;
    }

    .card-link:hover .card {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: rgba(13, 255, 220, .45);
    }

    .row {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid rgba(8, 67, 145, .16);
      background: #e9eef8;
      flex: 0 0 auto;
    }

    .text {
      min-width: 0;
      flex: 1;
    }

    /* ✅ Nombre SIEMPRE en una sola línea */
    .name {
      font-family: "Josefin Sans", sans-serif;
      font-weight: 700;
      font-size: 15px;
      line-height: 1.2;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta {
      color: var(--muted);
      font-size: 12.5px;
      margin-top: 3px;
      line-height: 1.25;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .chip {
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      border: 1px solid rgba(8, 67, 145, .14);
      background: rgba(8, 67, 145, .06);
      color: var(--primary);
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: filter .15s ease, transform .06s ease, background .15s ease;
      user-select: none;
      white-space: nowrap;
    }

    .chip:hover {
      filter: brightness(1.03);
    }

    .chip:active {
      transform: translateY(1px);
    }

    .chip-danger {
      background: rgba(176, 0, 32, .08);
      border-color: rgba(176, 0, 32, .20);
      color: #b00020;
    }

    form {
      margin: 0;
    }

    .readonly {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(8, 67, 145, .16);
      background: rgba(255, 255, 255, .7);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }

    .readonly::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(8, 67, 145, .28);
    }

    .panel {
      background: var(--card);
      border: 1px solid rgba(8, 67, 145, .10);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 16px;
      height: fit-content;
    }

    .panel h2 {
      margin: 0;
      font-family: "Josefin Sans", sans-serif;
      font-weight: 700;
      letter-spacing: .2px;
      font-size: 18px;
    }

    .sep {
      height: 1px;
      background: rgba(8, 67, 145, .10);
      margin: 12px 0;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(8, 67, 145, .14);
      background: rgba(8, 67, 145, .06);
      font-size: 12px;
      margin: 0 6px 6px 0;
      color: #0b2447;
      white-space: nowrap;
    }

    .badge b {
      color: var(--primary);
    }

    .panel h3 {
      margin: 0 0 6px 0;
      font-family: "Josefin Sans", sans-serif;
      font-weight: 700;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .3px;
      color: #0b2447;
    }

    .panel-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      min-width: 260px;
      max-width: 360px;
      padding: 14px 16px;
      border-radius: 14px;
      font-size: 13px;
      color: var(--ink);
      background: #fff;
      box-shadow: var(--shadow);
      border-left: 6px solid;
      animation: slideIn .3s ease, fadeOut .3s ease 2.7s forwards;
    }

    .toast.success {
      border-color: var(--secondary);
    }

    .toast.error {
      border-color: rgba(176, 0, 32, .75);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(18px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateX(18px);
      }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(6, 26, 51, .55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .modal {
      width: 100%;
      max-width: 440px;
      background: #fff;
      border-radius: 18px;
      border: 1px solid rgba(8, 67, 145, .12);
      box-shadow: 0 18px 55px rgba(6, 26, 51, .30);
      padding: 18px;
      animation: modalIn .18s ease;
    }

    .modal-title {
      font-family: "Josefin Sans", sans-serif;
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 8px;
    }

    .modal-text {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .modal-btn {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(8, 67, 145, .14);
      background: rgba(8, 67, 145, .06);
      cursor: pointer;
      font-weight: 700;
      font-family: Roboto, sans-serif;
      transition: filter .15s ease, transform .06s ease, background .15s ease;
      white-space: nowrap;
    }

    .modal-btn:hover {
      filter: brightness(1.03);
    }

    .modal-btn:active {
      transform: translateY(1px);
    }

    .modal-btn.danger {
      background: rgba(176, 0, 32, .08);
      border-color: rgba(176, 0, 32, .20);
      color: var(--danger);
    }

    @keyframes modalIn {
      from {
        transform: translateY(8px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    footer {
      margin-top: auto;
      text-align: center;
      font-size: 12px;
      color: #5a6a82;
      padding: 16px;
      font-family: Roboto, sans-serif;
    }
  </style>
</head>

<body>
  <div class="page">

    <header class="hero">
      <div class="hero-top">
        <span class="logo-pill" aria-hidden="true">
          <img class="logo-img" th:src="@{/image/testok-logo.png}" src="/image/testok-logo.png" alt="Testok" />
        </span>
        <div class="brand-tag">Encontrá el perfil, detrás del perfil.</div>
      </div>

      <div class="nav">
        <div class="nav-inner">
          <div class="nav-left">
            <span class="kicker">Panel Empresas</span>
            <p class="subtitle">Gestión de empleados: alta, edición, eliminación y detalle.</p>
          </div>

          <div class="nav-actions">
            <!-- ✅ SOLO SUPERADMIN ve este botón -->
            <sec:authorize access="hasAuthority('ROLE_SUPERADMIN')">
              <a class="btn btn-light" th:href="@{/admin/usuarios}">
                Ver usuarios administradores (solo disponible para testok)
              </a>
            </sec:authorize>

            <a class="btn btn-light" th:href="@{/admin/clientes/nuevo}">Agregar nuevo empleado</a>

            <!-- ✅ Logout correcto (POST) -->
            <form th:action="@{/logout}" method="post" style="margin:0; display:inline;">
              <button class="btn btn-ghost" type="submit">Cerrar sesión</button>
            </form>
          </div>
        </div>
      </div>
    </header>

    <!-- Toasts -->
    <div id="toast-container">
      <div class="toast success" th:if="${ok}" th:text="${ok}"></div>
      <div class="toast error" th:if="${err}" th:text="${err}"></div>
    </div>

    <div class="container">

      <div th:if="${#lists.isEmpty(clientes)}" class="msg msg-err">
        No hay clientes todavía.
      </div>

      <!-- ✅ Agregamos clase dinámica: si hay seleccionado => has-panel -->
      <div class="layout" th:if="${!#lists.isEmpty(clientes)}"
        th:classappend="${seleccionado != null} ? ' has-panel' : ''">

        <div class="grid">
          <a class="card-link" th:each="c : ${clientes}" th:href="@{/admin/clientes(ver=${c.id})}">
            <article class="card">
              <div class="row">
                <img class="avatar"
                  th:src="${(c.fotoPerfilUrl != null && !#strings.isEmpty(c.fotoPerfilUrl)) ? c.fotoPerfilUrl : 'https://via.placeholder.com/200'}"
                  alt="Foto de perfil" />
                </div>
                <div class="text">
                  <div class="name" th:text="${c.nombre + ' ' + c.apellido}">Nombre Apellido</div>
                  <div class="meta"><span th:text="${c.edad}">0</span> años</div>
                </div>

              <div class="actions">
                <div th:if="${c.createdBy != null && c.createdBy.username == usernameLogueado}"
                  style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                  <span class="chip" th:attr="data-href=@{'/admin/clientes/' + ${c.id} + '/editar'}"
                    onclick="event.preventDefault(); event.stopPropagation(); window.location=this.getAttribute('data-href');">
                    Editar
                  </span>

                  <form class="delete-form" th:action="@{'/admin/clientes/' + ${c.id} + '/eliminar'}" method="post"
                    onsubmit="event.preventDefault(); event.stopPropagation(); abrirModalEliminar(this);">
                    <button class="chip chip-danger" type="submit">Eliminar</button>
                  </form>
                </div>

                <span class="readonly" th:if="${c.createdBy == null || c.createdBy.username != usernameLogueado}">
                  Solo lectura
                </span>
              </div>
            </article>
          </a>
        </div>

        <aside class="panel" th:if="${seleccionado != null}">
          <div class="row">
            <img class="avatar"
              th:src="${(seleccionado.fotoPerfilUrl != null && !#strings.isEmpty(seleccionado.fotoPerfilUrl)) ? seleccionado.fotoPerfilUrl : 'https://via.placeholder.com/200'}"
              alt="Foto de perfil" />
            <div class="text">
              <h2 th:text="${seleccionado.nombre + ' ' + seleccionado.apellido}">Nombre Apellido</h2>
              <div class="meta"><span th:text="${seleccionado.edad}">0</span> años</div>

              <div style="margin-top:10px;">
                <span class="readonly"
                  th:if="${seleccionado.createdBy == null || seleccionado.createdBy.username != usernameLogueado}">
                  Solo lectura
                </span>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div>
            <span class="badge">Desempeño: <b th:text="${seleccionado.desempeno}">0</b>/10</span>
            <span class="badge">Reputación: <b th:text="${seleccionado.reputacionLaboral}">0</b>/10</span>
            <span class="badge">Cumplimiento: <b th:text="${seleccionado.cumplimiento}">0</b>/10</span>
            <span class="badge">Habilidades blandas: <b th:text="${seleccionado.habilidadesBlandas}">0</b>/10</span>
          </div>

          <div class="sep"></div>

          <div>
            <h3>Historial</h3>
            <div class="meta" th:text="${seleccionado.historial != null ? seleccionado.historial : '—'}">—</div>
          </div>

          <div class="sep"></div>

          <div>
            <h3>Valoraciones generales</h3>
            <div class="meta"
              th:text="${seleccionado.valoracionesGenerales != null ? seleccionado.valoracionesGenerales : '—'}">—</div>
          </div>

          <div class="panel-actions">
            <a class="btn btn-ghost" th:href="@{/admin/clientes}">Cerrar detalle</a>

            <a class="btn btn-light"
              th:if="${seleccionado.createdBy != null && seleccionado.createdBy.username == usernameLogueado}"
              th:href="@{'/admin/clientes/' + ${seleccionado.id} + '/editar'}">
              Editar
            </a>
          </div>
        </aside>

      </div>
    </div>

    <footer>
      © <span th:text="${#dates.format(#dates.createNow(), 'yyyy')}">2025</span> Testok Argentina
    </footer>
  </div>

  <!-- Modal -->
  <div id="modal-overlay" class="modal-overlay" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div id="modal-title" class="modal-title">Confirmar eliminación</div>
      <div class="modal-text">¿Estás seguro que deseas eliminar el empleado?</div>

      <div class="modal-actions">
        <button type="button" class="modal-btn" onclick="cerrarModalEliminar()">Cancelar</button>
        <button type="button" class="modal-btn danger" onclick="confirmarEliminar()">Eliminar</button>
      </div>
    </div>
  </div>

  <script>
    setTimeout(() => {
      document.querySelectorAll('.toast').forEach(t => t.remove());
    }, 3000);

    let formAEliminar = null;

    function abrirModalEliminar(form) {
      formAEliminar = form;
      document.getElementById('modal-overlay').style.display = 'flex';
    }

    function cerrarModalEliminar() {
      formAEliminar = null;
      document.getElementById('modal-overlay').style.display = 'none';
    }

    function confirmarEliminar() {
      if (formAEliminar) formAEliminar.submit();
    }

    document.addEventListener('click', function (e) {
      const overlay = document.getElementById('modal-overlay');
      if (!overlay || overlay.style.display === 'none') return;
      if (e.target === overlay) cerrarModalEliminar();
    });

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') cerrarModalEliminar();
    });
  </script>
</body>

</html>
